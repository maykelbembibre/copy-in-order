package copy_in_order.ui.j_components.buttons;

import java.awt.Component;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.beans.PropertyChangeListener;
import java.io.File;
import java.util.Arrays;
import java.util.Collection;
import java.util.Set;

import javax.swing.JButton;
import javax.swing.JProgressBar;
import javax.swing.JTextArea;

import copy_in_order.ui.AppWindow;
import copy_in_order.ui.j_components.FileJTextField;
import copy_in_order.ui.listeners.FileCopyPropertyChangeListener;
import copy_in_order.ui.workers.FileCopyTask;

/**
 * The start button.
 */
public class StartJButton extends JButton {

	private static final long serialVersionUID = -6805354002802955071L;

	/**
	 * Creates a button that starts a task.
	 * @param appWindow The root app window.
	 * @param progressBar The progress bar for the task that is going to start.
	 * @param taskOutput The text area to output the progress of the task that is going to start.
	 * @param stopButton The stop button for the task that is going to start.
	 */
	public StartJButton(AppWindow appWindow, JProgressBar progressBar, JTextArea taskOutput, JButton stopButton) {
		super("Copy files");
		FileJTextField sourceFileTextField = appWindow.getSourceFileTextField();
		FileJTextField destinationFileTextField = appWindow.getDestinationFileTextField();
		Collection<Component> sensitiveComponents = Arrays.asList(
			this, sourceFileTextField, destinationFileTextField,
			appWindow.getSourceFileChooseButton(), appWindow.getDestinationFileChooseButton()
		);
		this.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent e) {
				File sourceDirectory = sourceFileTextField.getSelectedFile();
				File destinationDirectory = destinationFileTextField.getSelectedFile();
				
				progressBar.setValue(0);
		    	taskOutput.setText("");
		    	for (Component component : sensitiveComponents) {
		    		component.setEnabled(false);
		    	}
		    	Set<File> selectedFiles = appWindow.getSelectedFiles();
		        
		        //Instances of javax.swing.SwingWorker are not reusuable, so
		        //we create new instances as needed.
		    	FileCopyTask task = new FileCopyTask(
		        	sourceDirectory, destinationDirectory, taskOutput, sensitiveComponents, stopButton, selectedFiles
		        );
		        PropertyChangeListener propertyChangeListener = new FileCopyPropertyChangeListener(
	            	progressBar, taskOutput, task
	            );
		        task.addPropertyChangeListener(propertyChangeListener);
		        appWindow.setTask(task);
		        task.execute();
		        
		        // After a task starts, the user has the possibility of stopping it.
		        stopButton.setEnabled(true);
			}
		});
	}
}
